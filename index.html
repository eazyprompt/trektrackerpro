<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
  />
  <title>Trek Tracker Pro</title>

  <link rel="icon" type="image/png" href="attachment_147008007.png">
  <link rel="apple-touch-icon" href="attachment_147008007.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

  <!-- W3.CSS + W3Schools icons (Font Awesome 4.7) -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- PackEx-like fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500;700&family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#020617;
      --panel: rgba(15,23,42,.55);
      --panel-strong: rgba(15,23,42,.78);
      --stroke: rgba(148,163,184,.18);
      --stroke-strong: rgba(148,163,184,.26);
      --text:#e5e7eb;
      --muted:#94a3b8;

      --blue:#3b82f6;
      --cyan:#06b6d4;
      --grad: linear-gradient(135deg, rgba(59,130,246,.95), rgba(6,182,212,.92));
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;

      --safe-bottom: env(safe-area-inset-bottom, 20px);
      --radius: 18px;
      --radius2: 22px;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --shadow2: 0 10px 35px rgba(0,0,0,.45);
    }

    html,body{height:100%}
    body{
      margin:0; padding:0; height:100vh; height:100dvh; overflow:hidden;
      background: var(--bg);
      font-family: Inter, Kanit, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
    }

    body::before{
      content:"";
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(59,130,246,.16), transparent 60%),
        radial-gradient(900px 600px at 85% 25%, rgba(6,182,212,.14), transparent 55%),
        linear-gradient(to bottom, rgba(2,6,23,.2), rgba(2,6,23,.85)),
        repeating-linear-gradient(0deg, rgba(148,163,184,.06) 0, rgba(148,163,184,.06) 1px, transparent 1px, transparent 24px),
        repeating-linear-gradient(90deg, rgba(148,163,184,.06) 0, rgba(148,163,184,.06) 1px, transparent 1px, transparent 24px);
      pointer-events:none;
      z-index:-1;
    }

    .leaflet-container{ background:#0b1222 !important; }
    #map-dashboard .leaflet-tile-pane{
      filter: invert(100%) hue-rotate(190deg) brightness(85%) contrast(90%);
    }
    .leaflet-bar{ box-shadow:none !important; border:none !important; }

    .glass-card{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .glass-strong{
      background: var(--panel-strong);
      border: 1px solid var(--stroke-strong);
      box-shadow: var(--shadow2);
    }
    .mono{ font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* Loading */
    #loading-overlay{
      position:fixed; inset:0;
      background: rgba(2,6,23,.92);
      display:none; align-items:center; justify-content:center;
      z-index:999998;
      flex-direction:column; color:white;
      backdrop-filter: blur(8px);
    }
    .spin-anim{ animation: spin .8s linear infinite; }
    @keyframes spin{ 100%{ transform: rotate(360deg); } }

    /* Modals */
    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.7);
      z-index:15000;
      display:none;
      align-items:center; justify-content:center;
      backdrop-filter: blur(10px);
      padding: 18px;
    }

    /* Auth pages */
    .auth-container{
      position:fixed; inset:0;
      z-index:20000;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding: 22px;
      text-align:center;
      background:
        linear-gradient(to bottom, rgba(2,6,23,.60), rgba(2,6,23,.92)),
        url('midnight-glow-over-peaks.3840x2160.jpg');
      background-size:cover;
      background-position:center;
    }

    /* ‚úÖ Balanced auth layout */
    .auth-shell{
      width:100%;
      max-width: 420px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 14px;
    }
    .header-banner{
      width:100%;
      height: 140px;
      border-radius: 22px;
      object-fit:cover;
      border: 1px solid rgba(148,163,184,.18);
      box-shadow: var(--shadow2);
    }

    .auth-card{
      width:100%;
      padding: 18px 18px 18px 18px;
      position:relative;
      overflow:hidden;
      border-radius: 22px;
    }
    .auth-card::after{
      content:"";
      position:absolute; inset:-2px;
      border-radius: inherit;
      background: linear-gradient(135deg, rgba(59,130,246,.20), rgba(6,182,212,.12), transparent 60%);
      pointer-events:none;
      mix-blend-mode: screen;
    }

    .auth-topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
      position:relative;
      z-index:1;
    }

    .glass-pill-btn{
      background: rgba(2,6,23,.45);
      border: 1px solid rgba(148,163,184,.22);
      color: #e2e8f0;
      padding: 6px 10px;
      border-radius: 999px;
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      font-size: 12px;
      backdrop-filter: blur(10px);
      transition: .2s;
      height: 34px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .glass-pill-btn:hover{
      border-color: rgba(59,130,246,.5);
      box-shadow: 0 0 0 3px rgba(59,130,246,.10);
    }

    .pill-sos{
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding: 6px 12px;
      height:34px;
      background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(244,63,94,.9));
      color:white;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-family:"JetBrains Mono", monospace;
      box-shadow: 0 0 18px rgba(239,68,68,.20), 0 14px 45px rgba(0,0,0,.40);
      display:flex; align-items:center; gap:8px;
    }
    .pill-sos:active{ transform: scale(.98); }

    .auth-hero{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;
      margin: 4px 0 12px 0;
      position:relative;
      z-index:1;
    }
    .auth-title{
      margin:0;
      font-size: 32px;
      font-weight: 900;
      letter-spacing: -0.8px;
      color:#fff;
      text-shadow: 0 18px 55px rgba(0,0,0,.6);
      line-height:1.05;
    }
    .auth-subtitle{
      margin:0;
      font-size: 12px;
      color: rgba(226,232,240,.82);
      letter-spacing: .18em;
      text-transform: uppercase;
    }

    .app-icon{
      width:76px; height:76px; object-fit:contain;
      filter: drop-shadow(0 0 18px rgba(59,130,246,.25));
      margin: 2px 0 8px 0;
      position:relative; z-index:1;
    }

    .auth-input{
      width:100%;
      padding: 13px 16px;
      margin-bottom: 12px;
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(148,163,184,.22);
      color:#fff;
      border-radius: 14px;
      outline:none;
      font-size: 15px;
      text-align:center;
      transition: .25s;
      position:relative; z-index:1;
    }
    .auth-input:focus{
      border-color: rgba(59,130,246,.65);
      box-shadow: 0 0 0 3px rgba(59,130,246,.18);
      background: rgba(2,6,23,.72);
    }
    .auth-btn{
      width:100%;
      padding: 13px 14px;
      border:none;
      border-radius: 999px;
      background: var(--grad);
      color:#fff;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.12em;
      text-transform: uppercase;
      display:flex; align-items:center; justify-content:center; gap:10px;
      box-shadow: 0 18px 55px rgba(59,130,246,.18);
      transition: transform .18s ease, filter .18s ease;
      position:relative; z-index:1;
    }
    .auth-btn:active{ transform: scale(.98); }
    .auth-link{
      margin-top: 14px;
      color: var(--muted);
      font-size: 13px;
      cursor:pointer;
      text-decoration:none;
      transition:.2s;
      position:relative; z-index:1;
    }
    .auth-link:hover{ color:#fff; text-decoration: underline; }

    /* Emergency overlay */
    #emergency-overlay{
      position:fixed; inset:0;
      z-index:99999;
      display:none;
      flex-direction:column;
      align-items:center; justify-content:center;
      background:#000;
    }
    .sos-flashing{ animation: sosFlash .5s infinite alternate; }
    @keyframes sosFlash{ 0%{ background:#000; } 100%{ background: rgba(6,182,212,1); } }
    .sos-text-big{ font-size:80px; font-weight:900; color:#fff; letter-spacing:6px; margin-bottom: 12px; }
    .sos-btn-stop{
      padding: 14px 36px;
      background:#fff;
      color:#000;
      font-weight:900;
      font-size: 20px;
      border-radius: 999px;
      border:none;
      cursor:pointer;
      box-shadow: 0 0 30px rgba(255,255,255,.35);
    }

    /* App container */
    #app-container{ display:none; height:100vh; width:100%; background: var(--bg); }
    .page-content{ height: calc(100vh - 66px); width:100%; display:none; position:relative; }
    .page-content.active{ display:block; }

    #map-report, #map-dashboard{ height:100%; width:100%; }
    #map-report{ height:45%; }

    #form-container{
      height:55%;
      background: rgba(2,6,23,.88);
      padding: 16px 16px 150px 16px;
      box-sizing:border-box;
      border-top: 1px solid rgba(148,163,184,.16);
      border-radius: 22px 22px 0 0;
      margin-top: -14px;
      position:relative;
      z-index:500;
      overflow-y:auto;
      backdrop-filter: blur(10px);
    }

    /* Tab bar */
    .tab-bar{
      position:fixed; left:0; right:0; bottom:0;
      height: 66px;
      padding-bottom: var(--safe-bottom);
      background: rgba(2,6,23,.86);
      border-top: 1px solid rgba(148,163,184,.16);
      display:flex;
      z-index:9999;
      backdrop-filter: blur(14px);
    }
    .tab-btn{
      flex:1;
      border:none;
      background: transparent;
      color: #64748b;
      font-family: Inter, Kanit, sans-serif;
      font-size: 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
    }
    .tab-btn i{ font-size: 18px; }
    .tab-btn.active{ color: var(--cyan); }

    /* Mode switch */
    .mode-switch{
      display:flex;
      margin-bottom: 12px;
      background: rgba(2,6,23,.55);
      border-radius: 14px;
      padding: 4px;
      border: 1px solid rgba(148,163,184,.16);
      gap: 6px;
    }
    .mode-btn{
      flex:1;
      padding: 9px 8px;
      border:none;
      background: transparent;
      color: #94a3b8;
      border-radius: 12px;
      font-weight: 700;
      font-size: 12px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .mode-btn.active{
      background: rgba(59,130,246,.18);
      color: #fff;
      border: 1px solid rgba(59,130,246,.25);
    }

    /* Inputs */
    input.app-input, textarea{
      width:100%;
      padding: 12px 12px;
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(148,163,184,.18);
      color:#fff;
      border-radius: 14px;
      margin-bottom: 10px;
      box-sizing:border-box;
      outline:none;
      font-family: Inter, Kanit, sans-serif;
      font-size: 14px;
      transition:.2s;
    }
    input.app-input:focus, textarea:focus{
      border-color: rgba(6,182,212,.55);
      box-shadow: 0 0 0 3px rgba(6,182,212,.12);
    }
    .input-error{
      border: 1px solid var(--danger) !important;
      box-shadow: 0 0 10px rgba(239,68,68,.35);
    }

    /* Custom dropdown */
    .select-wrap{ position:relative; margin-bottom: 10px; }
    .select-btn{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      color:#fff;
      display:flex; align-items:center; justify-content:space-between;
      cursor:pointer;
    }
    .select-left{ display:flex; align-items:center; gap:10px; }
    .select-left i{ width:18px; text-align:center; color: var(--cyan); }
    .select-hint{ color: rgba(226,232,240,.72); }
    .select-menu{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      display:none;
      max-height: 260px;
      overflow:auto;
      border-radius: 16px;
      background: rgba(2,6,23,.92);
      border: 1px solid rgba(148,163,184,.22);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(16px);
      z-index: 8000;
      padding: 6px;
    }
    .select-item{
      padding: 10px 10px;
      border-radius: 14px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      color: #e2e8f0;
    }
    .select-item i{ width:18px; text-align:center; color: var(--cyan); }
    .select-item:hover{
      background: rgba(59,130,246,.12);
      border: 1px solid rgba(59,130,246,.18);
    }
    .select-item.muted{ opacity:.55; cursor:default; }
    .select-item.muted:hover{ background:transparent; border: 1px solid transparent; }

    /* Submit buttons */
    .submit-btn{
      width:100%;
      padding: 13px 12px;
      background: var(--grad);
      border:none;
      border-radius: 14px;
      font-weight: 900;
      color:#fff;
      cursor:pointer;
      font-size: 14px;
      letter-spacing:.10em;
      text-transform: uppercase;
      box-shadow: 0 18px 45px rgba(6,182,212,.14);
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .submit-btn:active{ transform: scale(.98); }
    .btn-ghost{
      background: rgba(2,6,23,.45) !important;
      border: 1px solid rgba(148,163,184,.22) !important;
      box-shadow: none !important;
      color: #e2e8f0 !important;
    }

    /* Feed */
    #feed-wrapper{ height:100%; overflow-y:auto; padding: 14px 14px 110px 14px; box-sizing:border-box; }
    .feed-card{
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.14);
      border-left: 4px solid rgba(148,163,184,.4);
      margin-bottom: 12px;
      padding: 14px;
      border-radius: 16px;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }

    /* Floating GPS */
    .gps-float-wrapper{
      position:absolute; z-index:900; cursor:pointer;
      display:flex; flex-direction:column; align-items:center;
    }
    .gps-float-btn{
      width: 46px; height:46px;
      background: rgba(2,6,23,.65);
      border: 1px solid rgba(6,182,212,.45);
      border-radius: 999px;
      color:#fff;
      font-size: 18px;
      box-shadow: 0 14px 45px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      backdrop-filter: blur(10px);
    }
    .gps-pos-dashboard{ top: 16px; right: 14px; }
    .gps-pos-report{ top: 74px; right: 10px; }

    /* Dashboard panels */
    .map-tools-container{
      position:absolute; top: 74px; right: 14px; z-index: 1000;
      display:flex; flex-direction:column; gap: 12px; align-items:flex-end;
    }
    .tool-btn{
      background: rgba(2,6,23,.65);
      border: 1px solid rgba(148,163,184,.22);
      color: #e2e8f0;
      width: 42px; height: 42px;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      font-size: 18px;
      cursor:pointer;
      box-shadow: 0 14px 45px rgba(0,0,0,.32);
      transition: .18s;
      backdrop-filter: blur(10px);
    }
    .tool-btn:active{ transform: scale(.95); }
    .tool-btn.active{
      background: rgba(6,182,212,.18);
      border-color: rgba(6,182,212,.45);
      box-shadow: 0 0 0 3px rgba(6,182,212,.10);
      color: #fff;
    }

    .info-panel{
      position:absolute; top: 16px; right: 62px; width: 240px;
      background: rgba(2,6,23,.86);
      border-radius: 18px;
      padding: 14px;
      border: 1px solid rgba(148,163,184,.22);
      display:none;
      z-index:1001;
      box-shadow: var(--shadow2);
      max-height: 62vh;
      overflow-y:auto;
      color:#cbd5e1;
      font-size: 12px;
      backdrop-filter: blur(16px);
      animation: fadeInRight .22s ease;
    }
    .info-panel h3{
      margin: 0 0 10px 0;
      color:#fff;
      font-size: 13px;
      border-bottom: 1px solid rgba(148,163,184,.18);
      padding-bottom: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    @keyframes fadeInRight{
      from{ opacity:0; transform: translateX(16px); }
      to{ opacity:1; transform: translateX(0); }
    }

    /* Nav stop */
    .nav-stop-container{
      position:absolute;
      bottom: 120px;
      left:50%;
      transform: translateX(-50%);
      z-index:1000;
      display:none;
      animation: slideUp .22s ease;
    }
    @keyframes slideUp{ from{ opacity:0; transform: translate(-50%, 18px);} to{ opacity:1; transform: translate(-50%, 0);} }
    .btn-stop-nav{
      background: rgba(2,6,23,.72);
      color: #fff;
      border: 1px solid rgba(239,68,68,.35);
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      box-shadow: 0 14px 45px rgba(0,0,0,.35);
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      letter-spacing:.10em;
      text-transform: uppercase;
      backdrop-filter: blur(12px);
    }
    .btn-stop-nav i{ color: var(--danger); }

    /* Weather widget */
    #weather-widget{
      position:absolute; top: 126px; right: 10px; z-index: 900;
      display:none;
      align-items:center; gap:8px;
      background: rgba(2,6,23,.70);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148,163,184,.22);
      padding: 8px 12px;
      border-radius: 999px;
      color: #e2e8f0;
      font-size: 12px;
      cursor:pointer;
      box-shadow: 0 14px 45px rgba(0,0,0,.25);
      animation: fadeIn .35s ease;
    }
    #weather-temp{ font-weight:900; color: var(--ok); }
    @keyframes fadeIn{ from{ opacity:0; transform: translateY(-6px);} to{ opacity:1; transform: translateY(0);} }

    .leaflet-routing-container{ display:none !important; }
    .route-step-item{
      padding: 8px 0;
      border-bottom: 1px solid rgba(148,163,184,.10);
      display:flex; gap: 10px;
      align-items:flex-start;
    }
    .route-step-icon{ width: 22px; text-align:center; font-size: 16px; color: var(--cyan); }
    .route-step-text{ flex:1; color: #e2e8f0; }
    .route-step-dist{ font-size: 10px; color: #94a3b8; margin-left:auto; white-space:nowrap; }

    .row-between{ display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      font-size: 11px;
      color:#94a3b8;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(148,163,184,.14);
    }
    .chip i{ color: var(--cyan); }

    /* =========================================================
       ‚úÖ NEW: Tap-friendly buttons for Log cards + Popup NAV text black
    ========================================================== */
    .card-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .card-btn{
      appearance:none;
      -webkit-appearance:none;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.35);
      color:#e2e8f0;
      border-radius: 999px;
      min-height: 44px;
      min-width: 44px;
      padding: 10px 14px;
      font-weight: 900;
      letter-spacing: .08em;
      font-size: 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .card-btn:active{ transform: scale(.97); }
    .card-btn:focus{
      outline:none;
      box-shadow: 0 0 0 3px rgba(6,182,212,.18), 0 12px 30px rgba(0,0,0,.22);
      border-color: rgba(6,182,212,.55);
    }
    .card-btn.nav{
      border-color: rgba(6,182,212,.45);
      background: rgba(6,182,212,.16);
      color:#e2e8f0;
    }
    .card-btn.del{
      border-color: rgba(239,68,68,.40);
      background: rgba(239,68,68,.14);
      color:#fecaca;
      padding: 0;
      width: 44px;
      height: 44px;
    }
    .card-btn i{ font-size: 16px; }

    .popup-nav-btn{
      appearance:none;
      -webkit-appearance:none;
      border: 1px solid rgba(6,182,212,.55);
      background: rgba(103,232,249,.95);
      color:#000; /* ‚úÖ black text */
      padding: 10px 14px;
      border-radius: 999px;
      min-height: 44px;
      font-weight: 900;
      letter-spacing: .06em;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .popup-nav-btn:active{ transform: scale(.98); }
  </style>
</head>

<body>
  <!-- Loading -->
  <div id="loading-overlay">
    <img src="attachment_147008007.png" class="spin-anim" style="width: 60px; height: 60px;">
    <div style="margin-top:14px; letter-spacing:.14em; font-weight:900;" class="mono" id="loading-text">CONNECTING...</div>
  </div>

  <audio id="sos-silent-player" loop playsinline style="display:none;">
    <source src="https://raw.githubusercontent.com/anars/blank-audio/master/10-minutes-of-silence.mp3" type="audio/mpeg">
  </audio>

  <!-- Emergency -->
  <div id="emergency-overlay">
    <div class="sos-text-big">SOS</div>
    <div style="color:white; margin-bottom:30px; font-size:18px; letter-spacing:.08em;" class="mono">HELP ME!</div>
    <button class="sos-btn-stop" onclick="stopEmergencyMode()"><i class="fa fa-stop"></i> STOP</button>
  </div>

  <!-- Travel mode modal -->
  <div id="nav-mode-modal" class="modal-overlay">
    <div class="glass-card glass-strong" style="max-width: 320px; width:100%; text-align: center; padding: 22px;">
      <h3 style="color:white; margin:0 0 8px 0; font-size: 18px;" id="txt-nav-title"><i class="fa fa-flag-checkered"></i> Travel Mode</h3>
      <p style="color:#cbd5e1; font-size:13px; margin:0 0 14px 0;" id="txt-nav-desc">Choose mode</p>

      <div style="display:flex; flex-direction:column; gap:10px; width:100%;">
        <button class="auth-btn" onclick="confirmNavMode('driving')" style="margin-top:0;">
          <i class="fa fa-car"></i> <span id="txt-nav-drive">Driving</span>
        </button>

        <button class="auth-btn" onclick="confirmNavMode('walking')" style="margin-top:0; background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(6,182,212,.85));">
          <i class="fa fa-male"></i> <span id="txt-nav-walk">Walking</span>
        </button>

        <button class="auth-btn btn-ghost" onclick="document.getElementById('nav-mode-modal').style.display='none'">
          <i class="fa fa-times"></i> <span id="txt-nav-cancel">Cancel</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settings-modal" class="modal-overlay">
    <div class="glass-card glass-strong" style="max-width: 340px; width:100%; padding: 18px;">
      <div class="row-between">
        <h2 style="margin:0; color:white; font-size:18px;"><i class="fa fa-cog"></i> Settings</h2>
        <button class="glass-pill-btn" onclick="closeSettings()"><i class="fa fa-times"></i></button>
      </div>

      <div style="height:10px"></div>

      <div style="width:100%; text-align:left; margin-bottom:6px; font-size:12px; color:#cbd5e1;">
        <i class="fa fa-envelope"></i> Emergency Email
      </div>

      <input type="email" id="sos-email" class="auth-input" placeholder="name@example.com"
        style="margin-bottom:12px; font-size:14px; padding:10px;" onchange="saveEmailSettings()">

      <button class="auth-btn" onclick="startEmergencyMode()"
        style="background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(244,63,94,.9));">
        <i class="fa fa-bolt"></i> <span id="btn-sos-flash">SOS Mode</span>
      </button>

      <div style="height:12px"></div>

      <button class="auth-btn btn-ghost" onclick="downloadOfflineMap()">
        <i class="fa fa-download"></i> <span id="btn-dl-map">Offline Map</span>
      </button>

      <button class="auth-btn btn-ghost" onclick="clearAppCache()" style="margin-top:10px;">
        <i class="fa fa-trash"></i> <span id="btn-clear-cache">Clear Cache</span>
      </button>

      <button class="auth-btn btn-ghost" onclick="doLogout()"
        style="margin-top:10px; border-color: rgba(239,68,68,.35) !important; color:#fecaca !important;">
        <i class="fa fa-sign-out"></i> <span id="btn-logout-modal">Logout</span>
      </button>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="page-login" class="auth-container">
    <div class="auth-shell">
      <img src="midnight-glow-over-peaks.3840x2160.jpg" class="header-banner" alt="Header">

      <div class="glass-card glass-strong auth-card">
        <!-- ‚úÖ balanced topbar -->
        <div class="auth-topbar">
          <div class="glass-pill-btn" onclick="toggleLanguage()">
            <img class="lang-flag" id="lang-img-login" src="https://flagcdn.com/24x18/gb.png" style="width:16px;">
            <span id="lang-text-login">EN</span>
          </div>

          <button class="pill-sos" onclick="startEmergencyModeLogin()">
            <i class="fa fa-bolt"></i> SOS
          </button>
        </div>

        <div class="auth-hero">
          <img src="attachment_147008007.png" class="app-icon" alt="App Icon">
          <h1 class="auth-title" id="hero-title-login">Trek Tracker Pro</h1>
          <p class="auth-subtitle" id="hero-sub-login">Navigate Nature with Confidence</p>
        </div>

        <input type="text" id="login-user" class="auth-input" placeholder="Username">
        <input type="password" id="login-pass" class="auth-input" placeholder="Password">

        <button class="auth-btn" onclick="doLogin()" id="btn-login">
          <i class="fa fa-play"></i> START <i class="fa fa-angle-right"></i>
        </button>

        <div class="auth-link" onclick="showRegister()" id="link-reg">Create an Account</div>
        <!-- ‚úÖ GPS status removed -->
      </div>
    </div>
  </div>

  <!-- REGISTER -->
  <div id="page-register" class="auth-container" style="display:none;">
    <div class="auth-shell">
      <img src="midnight-glow-over-peaks.3840x2160.jpg" class="header-banner" alt="Header">

      <div class="glass-card glass-strong auth-card">
        <div class="auth-topbar">
          <div class="glass-pill-btn" onclick="toggleLanguage()">
            <img class="lang-flag" id="lang-img-reg" src="https://flagcdn.com/24x18/gb.png" style="width:16px;">
            <span id="lang-text-reg">EN</span>
          </div>
          <div class="glass-pill-btn" onclick="showLogin()">
            <i class="fa fa-arrow-left"></i> <span id="link-login-top">Back</span>
          </div>
        </div>

        <div class="auth-hero">
          <img src="attachment_147008007.png" class="app-icon" style="width:64px;height:64px;" alt="App Icon">
          <h1 class="auth-title" id="title-reg" style="font-size:28px;">Join the Trek</h1>
          <p class="auth-subtitle" id="reg-sub">Start your journey today</p>
        </div>

        <input type="text" id="reg-name" class="auth-input" placeholder="Display Name">
        <input type="text" id="reg-user" class="auth-input" placeholder="Username">
        <input type="password" id="reg-pass" class="auth-input" placeholder="Password">

        <button class="auth-btn" onclick="doRegister()" id="btn-reg">
          <i class="fa fa-user-plus"></i> SIGN UP
        </button>

        <div class="auth-link" onclick="showLogin()" id="link-login">Back to Login</div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app-container">
    <!-- REPORT -->
    <div id="page-report" class="page-content active">
      <div id="map-report"></div>

      <div class="glass-pill-btn" style="position:absolute; top:14px; left:14px; z-index:900;" onclick="toggleLanguage()">
        <img class="lang-flag" id="lang-img-report" src="https://flagcdn.com/24x18/gb.png" style="width:16px;">
        <span id="lang-text-report">EN</span>
      </div>

      <div id="weather-widget" onclick="locateUser()">
        <i class="fa fa-cloud"></i>
        <span id="weather-icon" style="display:none;">‚òÄÔ∏è</span>
        <span id="weather-temp">--¬∞C</span>
      </div>

      <div class="gps-float-wrapper gps-pos-report" onclick="locateUser()">
        <button class="gps-float-btn" aria-label="Locate">
          <i class="fa fa-crosshairs"></i>
        </button>
      </div>

      <div id="form-container" class="glass-strong">
        <div class="row-between" style="margin-bottom: 12px;">
          <div class="chip"><i class="fa fa-user"></i> <span id="display-username">Guest</span></div>
          <div class="chip mono" id="sync-status" style="display:none;"><i class="fa fa-rss"></i> <span id="sync-count">0</span> PENDING</div>
        </div>

        <div class="mode-switch">
          <button class="mode-btn active" id="btn-mode-point" onclick="setMode('point')"><i class="fa fa-map-pin"></i> <span>Pin</span></button>
          <button class="mode-btn" id="btn-mode-line" onclick="setMode('line')" style="display:none;"><i class="fa fa-random"></i> <span>Route</span></button>
          <button class="mode-btn" id="btn-mode-track" onclick="setMode('track')"><i class="fa fa-location-arrow"></i> <span>Track</span></button>
        </div>

        <div id="tracking-ui" style="display:none; margin-bottom: 10px;">
          <div style="display:flex; gap: 10px;">
            <button id="btn-track-start" class="submit-btn" style="display:none; background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(6,182,212,.75));"
              onclick="toggleTracking(true)">
              <i class="fa fa-play"></i> <span id="timer-display-start">00:00:00</span>
            </button>
            <button id="btn-track-stop" class="submit-btn" style="display:none; background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(244,63,94,.9));"
              onclick="toggleTracking(false)">
              <i class="fa fa-stop"></i> <span id="timer-display-stop">00:00:00</span>
            </button>
          </div>
        </div>

        <div class="row-between" style="font-size:12px; color:#94a3b8; margin-bottom: 8px;">
          <span id="coord-text">Tap map to pin</span>
          <span style="display:flex; gap:12px;">
            <span id="undoBtn" style="color:#e2e8f0; display:none; cursor:pointer;" onclick="undoLastPoint()"><i class="fa fa-undo"></i> Undo</span>
            <span id="clearBtn" style="color:#e2e8f0; cursor:pointer;" onclick="resetForm()"><i class="fa fa-times"></i> Clear</span>
          </span>
        </div>

        <form id="trekForm">
          <!-- Custom dropdown with W3 icons -->
          <div class="select-wrap">
            <button type="button" id="level-btn" class="select-btn" onclick="toggleLevelMenu()">
              <div class="select-left">
                <i class="fa fa-tag"></i>
                <span id="level-btn-text" class="select-hint">-- Please Select Type --</span>
              </div>
              <i class="fa fa-caret-down" style="color: rgba(226,232,240,.75)"></i>
            </button>
            <div id="level-menu" class="select-menu"></div>
            <!-- keep native select for logic -->
            <select id="level" class="app-input" style="display:none;"></select>
          </div>

          <textarea id="desc" rows="2" class="app-input" placeholder="Description..."></textarea>

          <div style="display:flex; gap:10px;">
            <button type="button" class="submit-btn" onclick="navigateToPin()" id="btn-nav" style="flex:1; display:none;">
              <i class="fa fa-location-arrow"></i> <span>NAVIGATE</span>
            </button>

            <button type="button" class="submit-btn" onclick="submitReport()" id="btn-save" style="flex:1; background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(6,182,212,.85));">
              <i class="fa fa-thumb-tack"></i> <span>PIN</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- FEED -->
    <div id="page-feed" class="page-content">
      <div id="feed-wrapper">
        <div class="row-between" style="margin-bottom: 12px;">
          <div style="display:flex; align-items:center; gap:10px;">
            <h2 style="color:white; margin:0; font-size:18px;" id="header-feed">Journey Log</h2>
            <div class="chip mono" id="sync-status-feed" style="display:none;"><i class="fa fa-rss"></i> <span id="sync-count-feed">0</span> PENDING</div>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <div class="glass-pill-btn" onclick="toggleLanguage()">
              <img id="lang-img" class="lang-flag" src="https://flagcdn.com/24x18/gb.png" style="width:16px;">
              <span id="lang-text">EN</span>
            </div>
            <div class="glass-pill-btn" id="btn-refresh" onclick="manualRefresh()">
              <i class="fa fa-refresh" id="refresh-icon"></i> <span>Refresh</span>
            </div>
          </div>
        </div>

        <input type="text" id="feedSearch" class="app-input" placeholder="Search..." onkeyup="filterFeed()">
        <div id="feed-list" style="margin-top:10px;">Loading...</div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page-content">
      <div id="map-dashboard"></div>

      <div class="map-tools-container">
        <button class="tool-btn" onclick="toggleMapPanel('legend')" id="btn-tool-legend" aria-label="Info">
          <i class="fa fa-info"></i>
        </button>
        <button class="tool-btn" onclick="toggleMapPanel('route')" id="btn-tool-route" style="display:none;" aria-label="Route">
          <i class="fa fa-road"></i>
        </button>
      </div>

      <div id="panel-legend" class="info-panel">
        <h3>
          <span><i class="fa fa-map"></i> Info</span>
          <span style="cursor:pointer" onclick="toggleMapPanel('legend')"><i class="fa fa-times"></i></span>
        </h3>
        <div id="legend-dynamic-content"></div>
      </div>

      <div id="panel-route" class="info-panel">
        <h3>
          <span><i class="fa fa-road"></i> Route</span>
          <span style="cursor:pointer" onclick="toggleMapPanel('route')"><i class="fa fa-times"></i></span>
        </h3>
        <div id="route-dynamic-content">Waiting for GPS...</div>
      </div>

      <div id="nav-stop-ui" class="nav-stop-container">
        <button class="btn-stop-nav" onclick="stopNavigation()">
          <i class="fa fa-times-circle"></i>
          <span>STOP NAV</span>
          <span id="dist-remain" style="font-weight:700; font-size:12px; margin-left:6px; color:#cbd5e1;">(-- m)</span>
        </button>
      </div>

      <div class="gps-float-wrapper gps-pos-dashboard" onclick="locateDashboardUser()">
        <button class="gps-float-btn" aria-label="Locate">
          <i class="fa fa-crosshairs"></i>
        </button>
      </div>
    </div>

    <!-- TAB BAR -->
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('report')"><i class="fa fa-compass"></i> <span id="tab-1-text">Navigate</span></button>
      <button class="tab-btn" onclick="switchTab('feed')"><i class="fa fa-book"></i> <span id="tab-2-text">Log</span></button>
      <button class="tab-btn" onclick="switchTab('dashboard')"><i class="fa fa-map-o"></i> <span id="tab-3-text">Map</span></button>
      <button class="tab-btn" onclick="showSettings()"><i class="fa fa-cog"></i> <span id="tab-setting-text">Setting</span></button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>

  <script>
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ‡πÉ‡∏™‡πà URL API ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
    const API_URL = "https://script.google.com/macros/s/AKfycby6M2uYrdElNMzdQXnJg01Xohq4P4urC5lJqZT62pMSJtviPaPQyPgEmmQipV0gGhCe/exec";
    const FIXED_SOS_EMAIL = "supanart.su@gmail.com";

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        try {
          if (window.location.protocol !== 'file:') {
            navigator.serviceWorker.register('./sw.js').then(() => console.log('SW Registered')).catch(err => console.log('SW Failed', err));
          }
        } catch(e) { console.log("SW skipped"); }
      });
    }

    var mapReport, mapDashboard;
    var feedLayerGroup = null;
    var tempMarker = null, tempLine = null, linePoints = [];
    var currentMode = 'point', currentAddress = "-", currentProvince = "";
    var allFeedData = [], currentUser = null;
    var curLang = localStorage.getItem('trekLang') || 'en';
    var myLocationMarker = null;
    var accCircle = null, watchId = null, trackingStarted = false, startTime = 0, timerInterval = null;
    var routingControl = null;
    const PENDING_KEY = 'trek_pending_uploads';
    let sosInterval = null;
    let audioContext = null;

    var navWatchId = null;
    var currentDestLatLng = null;
    var currentNavPos = null;

    var sosRetryInterval = null;
    var isSosAlertPending = false;

    // ‚úÖ Icon map (W3 / Font Awesome)
    function getLevelIcon(val){
      if(val === "Me") return "fa-user-circle";
      if(val.indexOf("‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£") !== -1 || val.indexOf("‡∏≠‡∏≤‡∏´‡∏≤‡∏£") !== -1) return "fa-cutlery";
      if(val.indexOf("‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà") !== -1) return "fa-coffee";
      if(val.indexOf("‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å") !== -1) return "fa-bed";
      if(val.indexOf("‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß") !== -1) return "fa-camera";
      if(val.indexOf("‡∏ä‡∏°‡∏ß‡∏¥‡∏ß") !== -1) return "fa-binoculars";
      if(val.indexOf("‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå") !== -1) return "fa-fire";
      if(val.indexOf("‡∏ô‡πâ‡∏≥") !== -1) return "fa-tint";
      if(val.indexOf("‡∏à‡∏≠‡∏î‡∏£‡∏ñ") !== -1) return "fa-car";
      if(val.indexOf("‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤") !== -1) return "fa-male";
      if(val.indexOf("‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢") !== -1) return "fa-warning";
      if(val.indexOf("‡∏≠‡∏∑‡πà‡∏ô") !== -1) return "fa-flag";
      return "fa-tag";
    }

    // ---------- Custom dropdown ----------
    function toggleLevelMenu(){
      const menu = document.getElementById('level-menu');
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }
    function closeLevelMenu(){
      const menu = document.getElementById('level-menu');
      if(menu) menu.style.display = 'none';
    }
    function setLevelValue(val, labelText){
      const sel = document.getElementById('level');
      sel.value = val;

      const icon = getLevelIcon(val);
      const btnText = document.getElementById('level-btn-text');
      btnText.classList.remove('select-hint');
      btnText.innerText = labelText;

      const btn = document.getElementById('level-btn');
      const left = btn.querySelector('.select-left i');
      left.className = "fa " + icon;

      closeLevelMenu();
    }
    document.addEventListener('click', (e) => {
      const wrap = document.querySelector('.select-wrap');
      if(!wrap) return;
      if(!wrap.contains(e.target)) closeLevelMenu();
    });

    // ---------- SOS retry ----------
    function sendSosWithRetry(data) {
      callApi('saveData', data).then(res => {
        if (res.status === 'SUCCESS') {
          localStorage.removeItem('pending_sos_packet');
          if (sosRetryInterval) { clearInterval(sosRetryInterval); sosRetryInterval = null; }
        } else {
          queueSosRetry(data);
        }
      }).catch(err => {
        console.error("SOS Send Fail:", err);
        queueSosRetry(data);
      });
    }

    function queueSosRetry(data) {
      console.log("‚ö†Ô∏è Offline/Error: Queuing SOS for retry...");
      if(data) localStorage.setItem('pending_sos_packet', JSON.stringify(data));
      if (!sosRetryInterval) {
        sosRetryInterval = setInterval(() => {
          console.log("üîÑ Retrying SOS Email (5 min interval)...");
          var pendingData = localStorage.getItem('pending_sos_packet');
          if (pendingData && navigator.onLine) {
            sendSosWithRetry(JSON.parse(pendingData));
          } else if (!pendingData) {
            clearInterval(sosRetryInterval);
            sosRetryInterval = null;
          }
        }, 300000);
      }
    }

    // ---------- Panels ----------
    function toggleMapPanel(type) {
      var panel = document.getElementById('panel-' + type);
      var btn = document.getElementById('btn-tool-' + type);

      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        btn.classList.remove('active');
      } else {
        document.querySelectorAll('.info-panel').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));

        panel.style.display = 'block';
        btn.classList.add('active');

        if (type === 'legend') {
          renderFeed(allFeedData);
        }
      }
    }

    // ---------- Nav choose modal ----------
    var pendingNavDest = null;

    function onCardNavClick(lat, lon) {
      pendingNavDest = { lat: lat, lng: lon };
      document.getElementById('nav-mode-modal').style.display = 'flex';
    }

    function navigateToPin() {
      if (!tempMarker) { alert(getTxt('alertPin')); return; }
      pendingNavDest = tempMarker.getLatLng();
      document.getElementById('nav-mode-modal').style.display = 'flex';
    }

    function confirmNavMode(mode) {
      document.getElementById('nav-mode-modal').style.display = 'none';
      if (pendingNavDest) {
        startInternalNav(pendingNavDest.lat, pendingNavDest.lng, mode);
        pendingNavDest = null;
      }
    }

    // ---------- Modes ----------
    function setMode(m) {
      if (watchId !== null) toggleTracking(false);
      currentMode = m;

      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      const levelSelect = document.getElementById('level');
      const trekForm = document.getElementById('trekForm');
      const trackingUI = document.getElementById('tracking-ui');

      if (m === 'point' || m === 'line') {
        document.getElementById('btn-mode-' + m).classList.add('active');
        trackingUI.style.display = 'none';
        trekForm.style.display = 'block';
        if (m === 'point') { levelSelect.disabled = false; }
        else { levelSelect.value = "‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤"; levelSelect.disabled = true; }
      } else if (m === 'track') {
        document.getElementById('btn-mode-track').classList.add('active');
        levelSelect.value = "‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤"; levelSelect.disabled = true;
        trackingUI.style.display = 'block';
        trekForm.style.display = 'none';
        document.getElementById('btn-track-start').style.display = 'block';
        document.getElementById('btn-track-stop').style.display = 'none';
        document.getElementById('timer-display-start').innerText = "00:00:00";
      }

      resetForm();

      document.getElementById('undoBtn').style.display = (m !== 'point') ? 'block' : 'none';

      var btnNav = document.getElementById('btn-nav');
      if (m === 'track' || m === 'line') btnNav.style.display = 'none';
      else btnNav.style.display = 'flex';

      applyLanguage();
    }

    function switchTab(t) {
      if (t !== 'dashboard' && navWatchId !== null) {
        alert(curLang === 'th'
          ? "‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà!\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° 'STOP NAV' ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤"
          : "‚ö†Ô∏è Navigation is active!\nPlease press 'STOP NAV' on the map before switching tabs.");
        return;
      }

      document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

      document.getElementById('page-' + t).classList.add('active');
      var idx = (t === 'feed') ? 1 : (t === 'dashboard') ? 2 : 0;
      document.querySelectorAll('.tab-btn')[idx].classList.add('active');

      const trekForm = document.getElementById('trekForm');
      const trackingUI = document.getElementById('tracking-ui');

      if (t === 'report') {
        if (currentMode === 'track') {
          trackingUI.style.display = 'block';
          trekForm.style.display = trackingStarted ? 'none' : 'block';
          document.getElementById('btn-track-start').style.display = trackingStarted ? 'none' : 'block';
          document.getElementById('btn-track-stop').style.display = trackingStarted ? 'block' : 'none';
        } else {
          trackingUI.style.display = 'none';
          trekForm.style.display = 'block';
        }
        setTimeout(() => locateUser(true), 300);
      } else {
        trackingUI.style.display = 'none';
      }

      if (t === 'dashboard') {
        if (feedLayerGroup) {
          feedLayerGroup.clearLayers();
          allFeedData.forEach(r => {
            var isSOS = (r[5] === "SOS Route" || r[6] === "SOS Route");
            var rawDesc = r[4];
            if (isSOS) {
              var cleanTextOnly = (rawDesc.indexOf(" || ") !== -1) ? rawDesc.split(" || ")[1] : "SOS Signal";
              drawOnMap(feedLayerGroup, r[1], r[2], r[3], cleanTextOnly, true);
            } else {
              drawOnMap(feedLayerGroup, r[1], r[2], r[3], rawDesc, true);
            }
          });
          if (mapDashboard && !mapDashboard.hasLayer(feedLayerGroup)) feedLayerGroup.addTo(mapDashboard);
        }
        setTimeout(() => locateDashboardUser(true), 300);
      }

      if (t === 'feed') {
        showLoading(true, "LOADING LOGS...");
        var icon = document.getElementById('refresh-icon');
        icon.classList.add('spin-anim');

        var start = Date.now();
        loadAllData(function () {
          var elapsed = Date.now() - start;
          var minWait = 1200;
          var remain = Math.max(0, minWait - elapsed);
          setTimeout(() => {
            icon.classList.remove('spin-anim');
            showLoading(false);
          }, remain);
        });
      }

      setTimeout(() => {
        if (t !== 'feed') {
          if (mapReport) mapReport.invalidateSize();
          if (mapDashboard) mapDashboard.invalidateSize();
        }
      }, 200);
    }

    // ---------- Settings ----------
    function saveEmailSettings() {
      if(!currentUser) return;
      var email = document.getElementById('sos-email').value;
      localStorage.setItem('trek_email_' + currentUser.username, email);
      if(navigator.onLine && email !== "") {
        callApi('updateUser', { username: currentUser.username, email: email });
      }
    }
    function loadEmailSettings() {
      if(!currentUser) return;
      var savedEmail = localStorage.getItem('trek_email_' + currentUser.username) || "";
      document.getElementById('sos-email').value = savedEmail;
    }
    function showSettings() {
      loadEmailSettings();
      document.getElementById('settings-modal').style.display = 'flex';
    }
    function closeSettings() {
      document.getElementById('settings-modal').style.display = 'none';
    }

    function downloadOfflineMap() {
      if(!mapReport) return;
      if(confirm(curLang==='th' ? "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå?" : "Download current map area for offline use?")) {
        showLoading(true, "CACHING MAP...");
        setTimeout(() => {
          showLoading(false);
          alert(curLang==='th' ? "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!" : "‚úÖ Area Cached!");
          closeSettings();
        }, 1200);
      }
    }

    function clearAppCache() {
      if(confirm(getTxt('confirmClearCache'))) {
        showLoading(true, "CLEANING...");
        if ('caches' in window) {
          caches.keys().then((names) => names.forEach(name => caches.delete(name)));
        }
        setTimeout(() => {
          showLoading(false);
          alert(curLang === 'th' ? "‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!" : "‚úÖ Cache Cleared!");
          location.reload();
        }, 900);
      }
    }

    // ---------- Weather ----------
    function fetchWeather(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;
      fetch(url).then(r => r.json()).then(data => {
        const temp = data.current_weather.temperature;
        const widget = document.getElementById('weather-widget');
        const tempEl = document.getElementById('weather-temp');
        tempEl.innerText = `${temp}¬∞C`;
        widget.style.display = "flex";
      }).catch(err => console.log("Weather Error:", err));
    }

    // ‚úÖ Language data
    const langData = {
      th: {
        flag: "https://flagcdn.com/24x18/th.png",
        loginBtn: "START",
        regLink: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà",
        regTitle: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
        regBtn: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£",
        loginLink: "‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
        loginSub: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á",
        regSub: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
        phUser: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
        phPass: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",
        phName: "‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á",
        logout: "‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",
        tabSetting: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤",
        btnDownloadMap: "‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå",
        btnSOSMode: "‡πÇ‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (SOS)",
        btnClearCache: "‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä (Clear Cache)",
        confirmClearCache: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)",
        modePoint: "‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î",
        modeLine: "‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô",
        modeTrack: "‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°",
        startBtn: "‡πÄ‡∏£‡∏¥‡πà‡∏°",
        stopBtn: "‡∏´‡∏¢‡∏∏‡∏î",
        coordHint: "‡πÅ‡∏ï‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏",
        descPlace: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...",
        saveBtn: "‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î",
        saveRoute: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á",
        feedHeader: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        feedSearch: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...",
        tab1: "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á",
        tab2: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
        tab3: "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà",
        confirmLogout: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?",
        loading: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...",
        processing: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...",
        alertPin: "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö",
        alertName: "üìù ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:",
        alertSave: "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!",
        alertLoginFail: "‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ú‡∏¥‡∏î",
        alertStopTrack: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô",
        alertOffline: "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï! ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÄ‡∏ô‡πá‡∏ï",
        selectHint: "-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --",
        alertSelect: "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö",
        btnNav: "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á",
        navInApp: "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (In-App)",
        navTitle: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        navDesc: "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏û‡∏≤‡∏´‡∏ô‡∏∞",
        navDrive: "‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå (Driving)",
        navWalk: "‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤ (Walking)",
        navCancel: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
        options: [
          {val:"Me", txt:"Me"},
          {val:"‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£", txt:"‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£"},
          {val:"‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà", txt:"‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà"},
          {val:"‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å", txt:"‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å"},
          {val:"‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", txt:"‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß"},
          {val:"‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß", txt:"‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß"},
          {val:"‡∏à‡∏∏‡∏î‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå", txt:"‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå"},
          {val:"‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥", txt:"‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥"},
          {val:"‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ", txt:"‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ"},
          {val:"‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤", txt:"‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤"},
          {val:"‡∏à‡∏∏‡∏î‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢", txt:"‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢"},
          {val:"‡∏≠‡∏∑‡πà‡∏ô‡πÜ", txt:"‡∏≠‡∏∑‡πà‡∏ô‡πÜ"},
        ],
        gpsFound: "üìç ‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß! (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ",
        gpsWait: "üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì...",
        delConfirm: "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?",
        delSuccess: "‚úÖ ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß",
        delFail: "‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"
      },
      en: {
        flag: "https://flagcdn.com/24x18/gb.png",
        loginBtn: "START",
        regLink: "Create an Account",
        regTitle: "Join the Trek",
        regBtn: "SIGN UP",
        loginLink: "Back to Login",
        loginSub: "Navigate Nature with Confidence",
        regSub: "Start your journey today",
        phUser: "Username",
        phPass: "Password",
        phName: "Display Name",
        logout: "Logout",
        tabSetting: "Setting",
        btnDownloadMap: "Download Offline Map",
        btnSOSMode: "SOS Mode",
        btnClearCache: "Clear Cache",
        confirmClearCache: "Clear all cache? (Offline maps will be removed)",
        modePoint: "Pin",
        modeLine: "Route",
        modeTrack: "Track",
        startBtn: "START",
        stopBtn: "STOP",
        coordHint: "Tap map to pin",
        descPlace: "Description...",
        saveBtn: "PIN",
        saveRoute: "SAVE ROUTE",
        feedHeader: "Journey Log",
        feedSearch: "Search...",
        tab1: "Navigate",
        tab2: "Log",
        tab3: "Map",
        confirmLogout: "Confirm Logout?",
        loading: "CONNECTING...",
        processing: "SAVING...",
        alertPin: "‚ö†Ô∏è Mark location first",
        alertName: "üìù Route Name:",
        alertSave: "‚úÖ Saved!",
        alertLoginFail: "‚ùå Invalid User/Pass",
        alertStopTrack: "Please press STOP first.",
        alertOffline: "‚ö†Ô∏è No Internet! Saved to device. Will sync automatically when online.",
        selectHint: "-- Please Select Type --",
        alertSelect: "‚ö†Ô∏è Please select a type first",
        btnNav: "NAVIGATE",
        navInApp: "NAVIGATE (In-App)",
        navTitle: "Travel Mode",
        navDesc: "Calculate route based on mode",
        navDrive: "Driving",
        navWalk: "Walking",
        navCancel: "Cancel",
        options: [
          {val:"Me", txt:"Me"},
          {val:"‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£", txt:"Restaurant"},
          {val:"‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà", txt:"Cafe"},
          {val:"‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å", txt:"Hotel"},
          {val:"‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", txt:"Attraction"},
          {val:"‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß", txt:"Viewpoint"},
          {val:"‡∏à‡∏∏‡∏î‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå", txt:"Campsite"},
          {val:"‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥", txt:"Water Source"},
          {val:"‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ", txt:"Parking"},
          {val:"‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤", txt:"Hiking Trail"},
          {val:"‡∏à‡∏∏‡∏î‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢", txt:"Danger"},
          {val:"‡∏≠‡∏∑‡πà‡∏ô‡πÜ", txt:"Other"},
        ],
        gpsWait: "üì° Locating...",
        gpsFound: "üìç Locked! (Acc: ",
        delConfirm: "Delete this item?",
        delSuccess: "‚úÖ Deleted",
        delFail: "‚ùå Failed"
      }
    };

    function toggleLanguage() {
      curLang = (curLang === 'th') ? 'en' : 'th';
      localStorage.setItem('trekLang', curLang);
      applyLanguage();
      renderFeed(allFeedData);
    }
    function getTxt(key) { return langData[curLang][key]; }

    function applyLanguage() {
      if (!langData[curLang]) curLang = 'en';
      const t = langData[curLang];
      const langTxt = curLang.toUpperCase();

      document.querySelectorAll('.lang-flag').forEach(el => el.src = t.flag);
      document.querySelectorAll('#lang-text, #lang-text-login, #lang-text-reg, #lang-text-report').forEach(el => el.innerText = langTxt);

      document.getElementById('link-reg').innerText = t.regLink;
      const heroSub = document.getElementById('hero-sub-login'); if(heroSub) heroSub.innerText = t.loginSub;

      const titleReg = document.getElementById('title-reg'); if(titleReg) titleReg.innerText = t.regTitle;
      const regSub = document.getElementById('reg-sub'); if(regSub) regSub.innerText = t.regSub;
      document.getElementById('link-login').innerText = t.loginLink;
      document.getElementById('link-login-top').innerText = t.loginLink;

      document.getElementById('login-user').placeholder = t.phUser;
      document.getElementById('login-pass').placeholder = t.phPass;
      document.getElementById('reg-user').placeholder = t.phUser;
      document.getElementById('reg-pass').placeholder = t.phPass;
      document.getElementById('reg-name').placeholder = t.phName;

      const btnLogout = document.getElementById('btn-logout-modal'); if(btnLogout) btnLogout.innerText = t.logout;
      const btnDlMap = document.getElementById('btn-dl-map'); if(btnDlMap) btnDlMap.innerText = t.btnDownloadMap;
      const tabSetting = document.getElementById('tab-setting-text'); if(tabSetting) tabSetting.innerText = t.tabSetting;
      const btnClearCache = document.getElementById('btn-clear-cache'); if(btnClearCache) btnClearCache.innerText = t.btnClearCache;
      const btnSOSMode = document.getElementById('btn-sos-flash'); if(btnSOSMode) btnSOSMode.innerText = t.btnSOSMode;

      const elNavTitle = document.getElementById('txt-nav-title'); if(elNavTitle) elNavTitle.innerHTML = `<i class="fa fa-flag-checkered"></i> ${t.navTitle}`;
      const elNavDesc = document.getElementById('txt-nav-desc'); if(elNavDesc) elNavDesc.innerText = t.navDesc;
      const elNavDrive = document.getElementById('txt-nav-drive'); if(elNavDrive) elNavDrive.innerText = t.navDrive;
      const elNavWalk = document.getElementById('txt-nav-walk'); if(elNavWalk) elNavWalk.innerText = t.navWalk;
      const elNavCancel = document.getElementById('txt-nav-cancel'); if(elNavCancel) elNavCancel.innerText = t.navCancel;

      document.getElementById('btn-mode-point').innerHTML = `<i class="fa fa-map-pin"></i> ${t.modePoint}`;
      document.getElementById('btn-mode-line').innerHTML = `<i class="fa fa-random"></i> ${t.modeLine}`;
      document.getElementById('btn-mode-track').innerHTML = `<i class="fa fa-location-arrow"></i> ${t.modeTrack}`;

      document.getElementById('coord-text').innerText = t.coordHint;
      document.getElementById('desc').placeholder = t.descPlace;

      document.getElementById('header-feed').innerText = t.feedHeader;
      document.getElementById('feedSearch').placeholder = t.feedSearch;

      document.getElementById('tab-1-text').innerText = t.tab1;
      document.getElementById('tab-2-text').innerText = t.tab2;
      document.getElementById('tab-3-text').innerText = t.tab3;

      const btnNav = document.getElementById('btn-nav');
      if(btnNav) btnNav.innerHTML = `<i class="fa fa-location-arrow"></i> <span>${t.btnNav}</span>`;

      const saveBtn = document.getElementById('btn-save');
      if(saveBtn){
        const label = (currentMode === 'line' || currentMode === 'track') ? t.saveRoute : t.saveBtn;
        saveBtn.innerHTML = `<i class="fa fa-thumb-tack"></i> <span>${label}</span>`;
      }

      const startBtn = document.getElementById('btn-track-start');
      const stopBtn = document.getElementById('btn-track-stop');
      if(startBtn) startBtn.innerHTML = `<i class="fa fa-play"></i> <span id="timer-display-start">00:00:00</span>`;
      if(stopBtn) stopBtn.innerHTML = `<i class="fa fa-stop"></i> <span id="timer-display-stop">00:00:00</span>`;

      // ‚úÖ Populate select + custom dropdown (includes "Me")
      const sel = document.getElementById('level');
      const selVal = sel.value;
      sel.innerHTML = "";

      let placeholder = document.createElement('option');
      placeholder.value = "";
      placeholder.innerText = t.selectHint;
      placeholder.disabled = true;
      placeholder.selected = true;
      sel.appendChild(placeholder);

      const menu = document.getElementById('level-menu');
      menu.innerHTML = "";
      const muted = document.createElement('div');
      muted.className = "select-item muted";
      muted.innerHTML = `<i class="fa fa-info-circle"></i> <span>${t.selectHint}</span>`;
      menu.appendChild(muted);

      t.options.forEach(opt => {
        let op = document.createElement('option');
        op.value = opt.val;
        op.innerText = opt.txt;
        sel.appendChild(op);

        const item = document.createElement('div');
        item.className = "select-item";
        const icon = getLevelIcon(opt.val);
        item.innerHTML = `<i class="fa ${icon}"></i> <span>${opt.txt}</span>`;
        item.onclick = () => setLevelValue(opt.val, opt.txt);
        menu.appendChild(item);
      });

      if (currentMode === 'line' || currentMode === 'track') {
        sel.value = "‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤";
        document.querySelector('.select-wrap').style.display = 'none';
      } else {
        document.querySelector('.select-wrap').style.display = 'block';
        if(selVal && selVal !== "") sel.value = selVal;
      }

      if(sel.value && sel.value !== ""){
        const match = t.options.find(o => o.val === sel.value);
        if(match) setLevelValue(sel.value, match.txt);
      } else {
        const btn = document.getElementById('level-btn');
        btn.querySelector('.select-left i').className = "fa fa-tag";
        const btnText = document.getElementById('level-btn-text');
        btnText.classList.add('select-hint');
        btnText.innerText = t.selectHint;
      }

      // Legend content
      let legendHtml = ``;
      t.options.forEach(opt => {
        let color = getLevelColor(opt.val);
        let icon = getLevelIcon(opt.val);
        legendHtml += `<div style="margin-bottom:8px; display:flex; align-items:center; gap:10px;">
          <div style="width:10px; height:10px; background:${color}; border-radius:999px;"></div>
          <i class="fa ${icon}" style="color: var(--cyan); width:16px; text-align:center;"></i>
          <span>${opt.txt}</span>
        </div>`;
      });
      document.getElementById('legend-dynamic-content').innerHTML = legendHtml;
    }

    // ---------- Timer ----------
    function updateTimer() {
      var savedStartTime = localStorage.getItem('sos_start_time');
      if (!savedStartTime) return;

      var elapsed = Date.now() - parseInt(savedStartTime);
      var totalSeconds = Math.floor(elapsed / 1000);
      var h = Math.floor(totalSeconds / 3600);
      var m = Math.floor((totalSeconds % 3600) / 60);
      var s = totalSeconds % 60;

      var timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

      var timerStop = document.getElementById('timer-display-stop');
      var timerStart = document.getElementById('timer-display-start');
      if(timerStop) timerStop.innerText = timeStr;
      if(timerStart) timerStart.innerText = timeStr;
    }

    function startTimer() { startTime = Date.now(); updateTimer(); timerInterval = setInterval(updateTimer, 1000); }
    function stopTimer() {
      clearInterval(timerInterval); timerInterval = null;
      var stopEl = document.getElementById('timer-display-stop');
      var startEl = document.getElementById('timer-display-start');
      var finalTime = stopEl ? stopEl.innerText : "00:00:00";
      if(startEl) startEl.innerText = finalTime;
      if(stopEl) stopEl.innerText = "00:00:00";
      startTime = 0;
    }

    // ---------- Tracking + SOS ----------
    function startEmergencyMode() {
      document.getElementById('settings-modal').style.display = 'none';

      localStorage.removeItem('pending_sos_packet');
      if (sosRetryInterval) { clearInterval(sosRetryInterval); sosRetryInterval = null; }

      if (!localStorage.getItem('session_sos_sent')) isSosAlertPending = true;

      var audio = document.getElementById('sos-silent-player');
      if (audio) audio.play().catch(()=>{});

      if (!localStorage.getItem('sos_start_time')) localStorage.setItem('sos_start_time', Date.now());
      localStorage.setItem('is_sos_active', 'true');

      const overlay = document.getElementById('emergency-overlay');
      overlay.style.display = 'flex';
      overlay.classList.add('sos-flashing');

      setMode('track');
      if (!trackingStarted) toggleTracking(true);
    }

    function playBeep() {
      if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      if(audioContext.state === 'suspended') audioContext.resume();
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.type = 'square';
      osc.frequency.value = 800;
      gain.gain.value = 1;
      osc.start();
      setTimeout(() => { osc.stop(); }, 300);
    }

    function stopEmergencyMode() {
      const overlay = document.getElementById('emergency-overlay');
      overlay.style.display = 'none';
      overlay.classList.remove('sos-flashing');

      if (sosInterval) clearInterval(sosInterval);
      var audio = document.getElementById('sos-silent-player');
      if (audio) { audio.pause(); audio.currentTime = 0; }

      localStorage.removeItem('is_sos_active');
      localStorage.removeItem('sos_start_time');
      localStorage.removeItem('trek_saved_route');
      localStorage.removeItem('session_sos_sent');

      if (sosRetryInterval) {
        clearInterval(sosRetryInterval);
        sosRetryInterval = null;
      }
      localStorage.removeItem('pending_sos_packet');

      if (trackingStarted) {
        if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
        stopTimer();
        trackingStarted = false;

        if (linePoints.length > 0) {
          var lastPt = linePoints[linePoints.length - 1];
          var userEmail = localStorage.getItem('trek_emergency_override')
                        || document.getElementById('sos-email').value
                        || localStorage.getItem('trek_email_' + (currentUser ? currentUser.username : ""));
          localStorage.removeItem('trek_emergency_override');

          var reporter = currentUser ? currentUser.username : getDeviceName();

          var payload = {
            lat: lastPt[0], lon: lastPt[1],
            level: "‡∏à‡∏∏‡∏î‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢",
            desc: "üö® SOS CLOSED: Track Summary",
            type: "track",
            pathData: JSON.stringify(linePoints),
            locationName: "Emergency Location",
            searchLocation: "SOS Route",
            province: "-",
            reporterName: reporter,
            emergencyEmail: userEmail
          };

          callApi('saveData', payload).then(() => {
            switchTab('feed');
            setMode('point');
          });
        } else {
          resetForm(); setMode('point');
        }
      } else {
        resetForm(); setMode('point');
      }
    }

    function onPositionUpdate(pos) {
      var lat = pos.coords.latitude;
      var lng = pos.coords.longitude;
      var acc = pos.coords.accuracy;

      if (isSosAlertPending) {
        isSosAlertPending = false;
        localStorage.setItem('session_sos_sent', 'true');

        var userEmail = localStorage.getItem('trek_emergency_override')
                      || document.getElementById('sos-email').value
                      || localStorage.getItem('trek_email_' + (currentUser ? currentUser.username : ""));

        var reporter = currentUser ? currentUser.username : getDeviceName();

        var sosData = {
          lat: lat,
          lon: lng,
          level: "‡∏à‡∏∏‡∏î‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢",
          desc: "üö® SOS ACTIVATED! (Initial Location)",
          type: "point",
          locationName: "SOS Start Point",
          searchLocation: "SOS Alert",
          province: "-",
          reporterName: reporter,
          emergencyEmail: userEmail,
          timestamp: Date.now()
        };

        sendSosWithRetry(sosData);
      }

      linePoints.push([lat, lng]);

      if (currentMode === 'track' || localStorage.getItem('is_sos_active') === 'true') {
        localStorage.setItem('trek_saved_route', JSON.stringify(linePoints));
      }

      if (tempLine) mapReport.removeLayer(tempLine);
      tempLine = L.polyline(linePoints, {color: '#22c55e', weight: 4}).addTo(mapReport);

      mapReport.setView([lat, lng], 16);

      document.getElementById('coord-text').innerText = `TRACK ${linePoints.length} pts (Acc: ${Math.round(acc)}m)`;

      if (accCircle) mapReport.removeLayer(accCircle);
      accCircle = L.circle([lat, lng], { radius: acc, color: '#22c55e', fillColor: '#22c55e', fillOpacity: 0.10, weight: 1 }).addTo(mapReport);
    }

    function toggleTracking(shouldStart) {
      const trekForm = document.getElementById('trekForm');
      if (shouldStart) {
        if (!navigator.geolocation) { alert("GPS not supported"); return; }
        document.getElementById('coord-text').innerText = getTxt('gpsWait');
        watchId = navigator.geolocation.watchPosition(onPositionUpdate, () => {}, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
        startTimer(); trackingStarted = true;
        document.getElementById('btn-track-start').style.display = 'none';
        document.getElementById('btn-track-stop').style.display = 'block';
        trekForm.style.display = 'none';
        document.getElementById('coord-text').innerText = `TRACKING...`;
      } else {
        if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
        stopTimer(); trackingStarted = false;
        document.getElementById('btn-track-start').style.display = 'block';
        document.getElementById('btn-track-stop').style.display = 'none';
        trekForm.style.display = 'block';
        document.getElementById('coord-text').innerText = `STOPPED.`;
      }
    }

    // ---------- API ----------
    async function callApi(action, data = {}) {
      if (action === 'getData') {
        if (!navigator.onLine) return [];
        try {
          const response = await fetch(API_URL + "?action=getData");
          return await response.json();
        } catch(e) { return []; }
      } else {
        const payload = { action: action, ...data };
        if (!navigator.onLine && action === 'saveData') { saveOffline(payload); return { status: "OFFLINE_SAVED", message: "Saved offline" }; }
        try {
          const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload), headers: { "Content-Type": "text/plain;charset=utf-8" } });
          return await response.json();
        } catch(e) {
          if (action === 'saveData') { saveOffline(payload); return { status: "OFFLINE_SAVED", message: "Network failed, saved offline" }; }
          return { status: "FAIL", message: e.toString() };
        }
      }
    }

    function saveOffline(payload) {
      let pending = JSON.parse(localStorage.getItem(PENDING_KEY) || "[]");
      pending.push(payload);
      localStorage.setItem(PENDING_KEY, JSON.stringify(pending));
      updateSyncStatus();
    }

    async function syncOfflineData() {
      if (!navigator.onLine) return;
      let pending = JSON.parse(localStorage.getItem(PENDING_KEY) || "[]");
      if (pending.length === 0) { updateSyncStatus(); return; }
      let remaining = [];
      for (let item of pending) {
        try {
          const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(item), headers: { "Content-Type": "text/plain;charset=utf-8" } });
          const resJson = await response.json();
          if (resJson.status !== 'SUCCESS') remaining.push(item);
        } catch(e) { remaining.push(item); }
      }
      localStorage.setItem(PENDING_KEY, JSON.stringify(remaining));
      updateSyncStatus();
      if (remaining.length === 0) { alert(curLang === 'th' ? "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!" : "‚úÖ Offline data synced!"); loadAllData(); }
    }

    function updateSyncStatus() {
      let pending = JSON.parse(localStorage.getItem(PENDING_KEY) || "[]");
      const badge = document.getElementById('sync-status');
      const count = document.getElementById('sync-count');
      const badge2 = document.getElementById('sync-status-feed');
      const count2 = document.getElementById('sync-count-feed');
      if (pending.length > 0) {
        badge.style.display = 'inline-flex';
        badge2.style.display = 'inline-flex';
        count.innerText = pending.length;
        count2.innerText = pending.length;
      } else {
        badge.style.display = 'none';
        badge2.style.display = 'none';
      }
    }

    window.addEventListener('online', syncOfflineData);

    function showLoading(s, t) {
      var o = document.getElementById('loading-overlay');
      if (s) {
        document.getElementById('loading-text').innerText = t || "Loading...";
        o.style.display = 'flex';
      } else {
        o.style.display = 'none';
      }
    }

    function getDeviceName() {
      const ua = navigator.userAgent;
      let device = "Unknown Device";
      if (/Android/i.test(ua)) device = "Android Phone";
      else if (/iPhone/i.test(ua)) device = "iPhone";
      else if (/iPad/i.test(ua)) device = "iPad";
      else if (/Macintosh/i.test(ua)) device = "Macbook/PC";
      else if (/Windows/i.test(ua)) device = "Windows PC";

      let browser = "Unknown Browser";
      if (/CriOS/i.test(ua) || /Chrome/i.test(ua)) browser = "Chrome";
      else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) browser = "Safari";
      else if (/Firefox/i.test(ua)) browser = "Firefox";

      return `${browser} on ${device}`;
    }

    function startEmergencyModeLogin() {
      var confirmMsg = curLang === 'th'
        ? `üö® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏´‡∏°‡∏î SOS: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà ${FIXED_SOS_EMAIL} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
        : `üö® CONFIRM SOS: System will start tracking and send an emergency email to ${FIXED_SOS_EMAIL}?`;

      if (!confirm(confirmMsg)) return;

      switchTab('dashboard');
      localStorage.setItem('trek_emergency_override', FIXED_SOS_EMAIL);
      startEmergencyMode();
    }

    // ---------- Maps ----------
    function initMaps() {
      if(mapReport) return;

      try {
        var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttr = '¬© OSM';

        mapReport = L.map('map-report', {
          zoomControl:false, minZoom:2, maxZoom:19,
          rotate:true, touchRotate:true, rotateControl:false
        }).setView([13.7563, 100.5018], 10);

        L.tileLayer(osmUrl, { maxZoom: 19, attribution: osmAttr }).addTo(mapReport);

        mapDashboard = L.map('map-dashboard', {
          zoomControl:false, minZoom:2, maxZoom:19,
          rotate:true, touchRotate:true, rotateControl:false
        }).setView([13.7563, 100.5018], 10);

        L.tileLayer(osmUrl, { maxZoom: 19, attribution: osmAttr }).addTo(mapDashboard);
        feedLayerGroup = L.layerGroup().addTo(mapDashboard);

        var geocoder = L.Control.geocoder({
          defaultMarkGeocode:false,
          geocoder: L.Control.Geocoder.nominatim({
            geocodingQueryParams: { 'accept-language': 'th,en', 'addressdetails': 1, 'limit': 10 }
          }),
          placeholder: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...',
          collapsed:false,
          position:'topright'
        })
        .on('markgeocode', function(e) {
          var center = e.geocode.center;
          mapReport.setView(center, 16);
          updateUserLocation(center.lat, center.lng, 0);
          var fullName = e.geocode.name || e.geocode.html;
          L.popup().setLatLng(center).setContent(`<div style="text-align:center; font-size:12px;"><b>${fullName}</b></div>`).openOn(mapReport);
        })
        .addTo(mapReport);

        mapReport.on('click', function(e) { updateUserLocation(e.latlng.lat, e.latlng.lng, 0); });

        setTimeout(function(){
          if(mapReport) mapReport.invalidateSize();
          if(mapDashboard) mapDashboard.invalidateSize();
        }, 500);
      } catch(e){
        console.error("Map Init Error:", e);
      }
    }

    // ---------- Locate ----------
    function locateUser(isAuto=false) {
      if (currentMode === 'track') {
        if (!trackingStarted) {
          if (!navigator.geolocation) { if(!isAuto) alert("GPS not supported"); return; }
          document.getElementById('coord-text').innerText = getTxt('gpsWait');
          navigator.geolocation.getCurrentPosition(function(pos){
            var lat = pos.coords.latitude, lng = pos.coords.longitude;
            linePoints = [[lat, lng]];
            mapReport.setView([lat,lng], 16);
            toggleTracking(true);
            if(!isAuto) alert(getTxt('gpsFound') + Math.round(pos.coords.accuracy) + "m)");
          }, function(err){ if(!isAuto) alert("GPS Error: " + err.message); }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
        } else {
          if(linePoints.length>0) mapReport.setView(linePoints[linePoints.length-1], 16);
        }
        return;
      }

      if (!navigator.geolocation) { if(!isAuto) alert("GPS not supported"); return; }
      document.getElementById('coord-text').innerText = getTxt('gpsWait');

      navigator.geolocation.getCurrentPosition(function(pos){
        var lat = pos.coords.latitude, lng = pos.coords.longitude, acc = pos.coords.accuracy;
        mapReport.setView([lat,lng], 16);
        updateUserLocation(lat,lng,acc);
        getAddress(lat,lng);
        if(!isAuto) alert(getTxt('gpsFound') + Math.round(acc) + "m)");
        fetchWeather(lat,lng);
      }, function(err){
        if(!isAuto) alert("GPS Error: " + err.message);
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    }

    function locateDashboardUser(isAuto=false) {
      if (navWatchId !== null && currentNavPos) {
        mapDashboard.setView([currentNavPos.lat, currentNavPos.lng], 17);
        return;
      }
      if (!navigator.geolocation) { if(!isAuto) alert("GPS not supported"); return; }

      navigator.geolocation.getCurrentPosition(function(pos){
        var lat = pos.coords.latitude, lng = pos.coords.longitude;
        mapDashboard.setView([lat,lng], 16);

        if(myLocationMarker) mapDashboard.removeLayer(myLocationMarker);
        myLocationMarker = L.circleMarker([lat,lng], {
          radius: 8, fillColor: "#3b82f6", color: "#ffffff", weight: 2, opacity: 1, fillOpacity: 0.9
        }).addTo(mapDashboard).bindPopup("You").openPopup();
      }, function(err){
        if(!isAuto) alert("GPS Error: " + err.message);
      }, { enableHighAccuracy:true });
    }

    function getAddress(lat, lng) {
      var url = "https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=" + lat + "&lon=" + lng + "&accept-language=th";
      fetch(url).then(r=>r.json()).then(d=>{
        var display = (d.address.village || d.address.suburb || d.address.city || d.display_name).substring(0,40);
        currentAddress = display; currentProvince = d.address.state || "";
        document.getElementById('coord-text').innerText = currentAddress;
      }).catch(()=>{
        currentAddress = lat.toFixed(5)+","+lng.toFixed(5);
        document.getElementById('coord-text').innerText = currentAddress;
      });
    }

    function updateUserLocation(lat,lng,accuracy){
      if (currentMode === 'point') {
        if (tempMarker) mapReport.removeLayer(tempMarker);
        if (accCircle) mapReport.removeLayer(accCircle);
        tempMarker = L.marker([lat,lng]).addTo(mapReport);
        linePoints = [[lat,lng]];
        getAddress(lat,lng);
        if (accuracy > 0) accCircle = L.circle([lat,lng], { radius: accuracy, color: '#06b6d4', fillColor: '#06b6d4', fillOpacity: 0.12, weight: 1 }).addTo(mapReport);
      } else if (currentMode === 'line') {
        linePoints.push([lat,lng]);
        if (tempLine) mapReport.removeLayer(tempLine);
        tempLine = L.polyline(linePoints, {color:'#06b6d4', weight:4, dashArray:'10,10'}).addTo(mapReport);
        document.getElementById('coord-text').innerText = "ROUTE " + linePoints.length + " pts";
      }
    }

    // ---------- Auth ----------
    function checkAuth() {
      var u = localStorage.getItem('trekUser');
      var n = localStorage.getItem('trekName');
      if(u && n) { currentUser = { username:u, name:n }; showApp(); }
      else showLogin();
    }
    function showLogin() {
      document.getElementById('page-login').style.display = 'flex';
      document.getElementById('page-register').style.display = 'none';
      document.getElementById('app-container').style.display = 'none';
    }
    function showRegister() {
      document.getElementById('page-login').style.display = 'none';
      document.getElementById('page-register').style.display = 'flex';
    }
    function showApp() {
      document.getElementById('page-login').style.display = 'none';
      document.getElementById('page-register').style.display = 'none';
      document.getElementById('app-container').style.display = 'block';
      document.getElementById('display-username').innerText = currentUser ? currentUser.name : 'Guest';
      setTimeout(function(){
        initMaps();
        switchTab('report');
        loadAllData();
        if(mapReport) mapReport.invalidateSize();
      }, 200);
    }

    function doLogin() {
      var u = document.getElementById('login-user').value;
      var p = document.getElementById('login-pass').value;

      if (!u || !p) {
        alert(curLang === 'th' ? "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" : "Please enter username and password.");
        return;
      }

      showLoading(true, curLang === 'th' ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö..." : "LOGGING IN...");
      callApi('loginUser', { username:u, password:p }).then(res=>{
        showLoading(false);
        if(res.status === 'SUCCESS') {
          localStorage.setItem('trekUser', u);
          localStorage.setItem('trekName', res.name);
          currentUser = { username:u, name:res.name };
          showApp();
        } else {
          alert(getTxt('alertLoginFail'));
        }
      }).catch(err=>{
        showLoading(false);
        alert("Login Error: " + err.message);
      });
    }

    function doRegister() {
      var n = document.getElementById('reg-name').value;
      var u = document.getElementById('reg-user').value;
      var p = document.getElementById('reg-pass').value;

      if (!n || !u || !p) {
        alert(curLang === 'th' ? "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô" : "Please fill in all fields.");
        return;
      }

      showLoading(true, curLang === 'th' ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." : "REGISTERING...");
      callApi('registerUser', { username:u, password:p, name:n }).then(res=>{
        showLoading(false);
        if(res.status === 'SUCCESS') {
          alert(curLang === 'th' ? "‚úÖ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!" : "‚úÖ Sign Up Successful!");
          showLogin();
        } else {
          alert("Registration Failed: " + (res.message || res.status));
        }
      }).catch(err=>{
        showLoading(false);
        alert("Network Error: " + err.message);
      });
    }

    function doLogout() {
      if(confirm(getTxt('confirmLogout'))) {
        closeSettings();
        localStorage.removeItem('trekUser');
        localStorage.removeItem('trekName');
        currentUser = null;
        location.reload();
      }
    }

    // ---------- Report / Feed / Map render ----------
    function submitReport() {
      if (watchId !== null && trackingStarted) { alert(getTxt('alertStopTrack')); return; }
      if (linePoints.length === 0) { alert(getTxt('alertPin')); return; }

      var selObj = document.getElementById('level');
      var l = selObj.value;

      if (currentMode === 'point' && selObj.selectedIndex === 0) {
        alert(getTxt('alertSelect'));
        switchTab('report');
        setTimeout(() => {
          document.getElementById('level-btn').classList.add('input-error');
        }, 200);
        setTimeout(() => {
          document.getElementById('level-btn').classList.remove('input-error');
        }, 1800);
        return;
      }

      var s = (currentMode === 'line' || currentMode === 'track') ? (prompt(getTxt('alertName')) || "") : currentAddress;
      if ((currentMode === 'line' || currentMode === 'track') && s === "") return;

      showLoading(true, getTxt('processing'));

      var d = document.getElementById('desc').value;
      var lat = linePoints[0][0];
      var lon = linePoints[0][1];
      var p = (currentMode === 'line' || currentMode === 'track') ? JSON.stringify(linePoints) : "";
      var r = currentUser ? currentUser.username : "Guest";
      if (currentMode !== 'point') l = "‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤";

      var payload = { lat: lat, lon: lon, level: l, desc: d, type: currentMode, pathData: p, locationName: currentAddress, searchLocation: s, province: currentProvince, reporterName: r };

      callApi('saveData', payload).then(res => {
        showLoading(false);
        if(res.status === 'SUCCESS') {
          alert(getTxt('alertSave'));
          resetForm();
          loadAllData();
          switchTab('feed');
        } else if(res.status === 'OFFLINE_SAVED') {
          alert(getTxt('alertOffline'));
          resetForm();
          switchTab('feed');
        } else {
          alert("Save Error: " + res.message);
        }
      }).catch(e => {
        showLoading(false);
        alert("Network Error: " + e.message);
      });
    }

    function resetForm() {
      if (watchId !== null) toggleTracking(false);
      if(tempMarker) mapReport.removeLayer(tempMarker);
      if(accCircle) mapReport.removeLayer(accCircle);
      if(tempLine) mapReport.removeLayer(tempLine);

      tempMarker=null; tempLine=null; accCircle=null; linePoints=[];
      document.getElementById('desc').value = "";

      const levelSelect = document.getElementById('level');
      if (currentMode === 'line' || currentMode === 'track') {
        levelSelect.value = "‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤";
        document.querySelector('.select-wrap').style.display = 'none';
      } else {
        levelSelect.selectedIndex = 0;
        document.querySelector('.select-wrap').style.display = 'block';
      }

      const btn = document.getElementById('level-btn');
      if(btn){
        btn.querySelector('.select-left i').className = "fa fa-tag";
        const btnText = document.getElementById('level-btn-text');
        btnText.classList.add('select-hint');
        btnText.innerText = getTxt('selectHint');
      }

      document.getElementById('coord-text').innerText = getTxt('coordHint');

      const trekForm = document.getElementById('trekForm');
      const trackingUI = document.getElementById('tracking-ui');

      if (currentMode === 'track') {
        trekForm.style.display = 'none';
        trackingUI.style.display = 'block';
        document.getElementById('btn-track-start').style.display = 'block';
        document.getElementById('btn-track-stop').style.display = 'none';
      } else {
        trekForm.style.display = 'block';
        trackingUI.style.display = 'none';
      }

      stopTimer();
      document.getElementById('weather-widget').style.display = "none";
    }

    function loadAllData(callback) {
      callApi('getData').then(d => {
        allFeedData = d || [];
        renderFeed(allFeedData);
        if(callback) callback();
      });
    }
    function filterFeed() {
      var t = document.getElementById('feedSearch').value.toLowerCase();
      renderFeed(allFeedData.filter(r => (r[5]+r[6]+r[3]).toLowerCase().indexOf(t) > -1));
    }

    function manualRefresh() {
      var icon = document.getElementById('refresh-icon');
      icon.classList.add('spin-anim');
      showLoading(true, "REFRESHING...");
      loadAllData(function(){
        setTimeout(function(){
          icon.classList.remove('spin-anim');
          showLoading(false);
        }, 500);
      });
    }

    function confirmDelete(timestampStr) {
      if(confirm(getTxt('delConfirm'))) {
        var myUser = currentUser ? currentUser.username : "";
        showLoading(true, "DELETING...");
        callApi('deleteItem', { timestamp: timestampStr, username: myUser }).then(res => {
          showLoading(false);
          if(res.status === 'SUCCESS') { alert(getTxt('delSuccess')); loadAllData(); }
          else { alert(getTxt('delFail')); }
        });
      }
    }

    function getLevelColor(l) {
      if(l === "Me") return "#06b6d4";
      if(l.indexOf("‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢")!=-1) return "#ef4444";
      if(l.indexOf("‡∏ô‡πâ‡∏≥")!=-1) return "#3b82f6";
      if(l.indexOf("‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå")!=-1) return "#22c55e";
      if(l.indexOf("‡∏ä‡∏°‡∏ß‡∏¥‡∏ß")!=-1 || l.indexOf("‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß")!=-1) return "#f59e0b";
      if(l.indexOf("‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£")!=-1 || l.indexOf("‡∏≠‡∏≤‡∏´‡∏≤‡∏£")!=-1 || l.indexOf("‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà")!=-1) return "#fb7185";
      if(l.indexOf("‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å")!=-1) return "#a855f7";
      if(l.indexOf("‡∏à‡∏≠‡∏î‡∏£‡∏ñ")!=-1) return "#94a3b8";
      return "#64748b";
    }

    function getLevelDisplay(val) {
      const m = langData[curLang].options.find(o => o.val === val);
      return m ? m.txt : val;
    }

    function drawOnMap(m, lat, lon, l, d, isD) {
      if(!m) return;
      var c = getLevelColor(l);
      var displayTitle = getLevelDisplay(l);
      var btnTxt = getTxt('navInApp');

      // ‚úÖ Popup NAV: black text
      var popupContent = `<div style='text-align:center;'>
        <b>${displayTitle}</b><br>
        <button type="button" class="popup-nav-btn" onclick="onCardNavClick(${lat}, ${lon})">
          <i class="fa fa-location-arrow"></i> ${btnTxt}
        </button>
      </div>`;

      if(d && d.indexOf("[PATH_DATA]")!=-1) {
        try {
          L.polyline(JSON.parse(d.split(" || ")[0].replace("[PATH_DATA]:","")), {color:c, weight:isD?3:5}).bindPopup(popupContent).addTo(m);
        } catch(e){}
      } else {
        L.circleMarker([lat, lon], {color:c, fillColor:c, fillOpacity:0.9, radius:6}).bindPopup(popupContent).addTo(m);
      }
    }

    function renderFeed(data) {
      if(feedLayerGroup) feedLayerGroup.clearLayers();
      if (!data || data.length === 0) {
        document.getElementById('feed-list').innerHTML = "<p style='text-align:center; color:#94a3b8; margin-top:24px;'>No Data</p>";
        return;
      }

      var html = "";
      var rev = data.slice().reverse();
      if(rev.length > 100) rev = rev.slice(0, 100);

      var myUser = currentUser ? currentUser.username : "";

      for (var i = 0; i < rev.length; i++) {
        try {
          var r = rev[i];
          var rawDate = new Date(r[0]);
          var dateStr = rawDate.toLocaleDateString(curLang === 'th' ? 'th-TH' : 'en-US', { day: 'numeric', month: 'short', year: '2-digit' });
          var timeStr = rawDate.toLocaleTimeString(curLang === 'th' ? 'th-TH' : 'en-US', { hour: '2-digit', minute: '2-digit' });

          var color = getLevelColor(r[3]);
          var isLineOrTrack = r[4].indexOf("[PATH_DATA]") !== -1;
          var cleanDesc = r[6] || r[5];
          var displayLevel = getLevelDisplay(r[3]);
          var icon = getLevelIcon(r[3]);

          // ‚úÖ Bigger delete button (tap-friendly)
          var deleteBtn = (r[8] === myUser)
            ? `<button type="button" class="card-btn del" onclick="confirmDelete('${r[0]}'); event.stopPropagation();" aria-label="Delete">
                 <i class="fa fa-trash"></i>
               </button>`
            : "";

          var cardDesc = isLineOrTrack ? r[4].split(" || ")[1] : r[4];

          // ‚úÖ Bigger NAV button (tap-friendly) + language aware label
          var navBtn = `<button type="button" class="card-btn nav"
            onclick="onCardNavClick(${r[1]}, ${r[2]}); event.stopPropagation();" aria-label="Navigate">
            <i class="fa fa-location-arrow"></i>
            <span>${getTxt('btnNav')}</span>
          </button>`;

          html += `<div class="feed-card" style="border-left-color:${color}" onclick="focusOnCard('${r[0]}')">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
              <span style="font-weight:900; font-size:14px; color:${color}; display:flex; align-items:center; gap:8px;">
                <i class="fa ${icon}" style="color:${color}"></i> ${displayLevel}
              </span>
              <div class="card-actions">
                <span class="chip" style="color:#cbd5e1;"><i class="fa fa-user"></i> ${r[8]||'Guest'}</span>
                ${deleteBtn}
              </div>
            </div>

            <div style="color:white; font-size:14px; font-weight:800; margin-bottom: 3px;">
              <i class="fa fa-map-marker" style="color: var(--cyan)"></i> ${cleanDesc}
            </div>

            <div style="color:#94a3b8; font-size:12px; margin-bottom:8px; display:flex; gap:10px; align-items:center; justify-content:space-between;">
              <span><i class="fa fa-clock-o"></i> ${dateStr} ${timeStr}</span>
              ${navBtn}
            </div>

            <div style="color:#cbd5e1; font-size:13px; border-top:1px solid rgba(148,163,184,.12); margin-top:6px; padding-top:8px;">
              <i class="fa fa-sticky-note-o" style="color: rgba(226,232,240,.75)"></i> ${cardDesc || '-'}
            </div>
          </div>`;

          if (!isLineOrTrack) drawOnMap(feedLayerGroup, r[1], r[2], r[3], r[4], true);
        } catch(e) {
          console.log("Render Error", i, e);
        }
      }

      document.getElementById('feed-list').innerHTML = html;
    }

    // ---------- Focus / Navigation ----------
    var currentFocusTimer = null;
    function focusOnCard(timestamp) {
      if (currentFocusTimer) { clearTimeout(currentFocusTimer); currentFocusTimer = null; }
      showLoading(true, "OPENING MAP...");

      document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('page-dashboard').classList.add('active');
      document.querySelectorAll('.tab-btn')[2].classList.add('active');

      if (mapDashboard) mapDashboard.invalidateSize();

      currentFocusTimer = setTimeout(() => { executeMapDraw(timestamp); }, 250);
    }

    function executeMapDraw(timestamp) {
      if(!mapDashboard) { showLoading(false); return; }

      mapDashboard.invalidateSize();
      if(feedLayerGroup) {
        feedLayerGroup.clearLayers();
        if(!mapDashboard.hasLayer(feedLayerGroup)) feedLayerGroup.addTo(mapDashboard);
      }

      const record = allFeedData.find(r => r[0] === timestamp);
      if (!record) { showLoading(false); return; }

      var rawData = record[4];
      var hasPathTag = rawData && rawData.indexOf("[PATH_DATA]") !== -1;

      if (hasPathTag) {
        try {
          var jsonMatch = rawData.match(/\[\[.*\]\]/);
          if (jsonMatch) {
            var points = JSON.parse(jsonMatch[0]);
            var color = getLevelColor(record[3]);

            var polyline = L.polyline(points, {
              color: color, weight: 6, opacity: 0.9, lineJoin: 'round',
              renderer: L.svg()
            }).addTo(feedLayerGroup);

            var btnTxt = getTxt('navInApp');
            var displayTitle = getLevelDisplay(record[3]);

            // ‚úÖ Popup NAV: black text
            var popupContent = `<div style='text-align:center;'>
              <b>${displayTitle}</b><br>
              <button type="button" class="popup-nav-btn" onclick="onCardNavClick(${record[1]}, ${record[2]})">
                <i class="fa fa-location-arrow"></i> ${btnTxt}
              </button>
            </div>`;
            polyline.bindPopup(popupContent);

            mapDashboard.fitBounds(polyline.getBounds(), { padding: [50, 50], animate: false });

            setTimeout(() => {
              if(mapDashboard) {
                mapDashboard.invalidateSize();
                polyline.redraw();
                showLoading(false);
              }
            }, 300);

          } else {
            fallbackDrawPoint(record);
            showLoading(false);
          }
        } catch(e) {
          fallbackDrawPoint(record);
          showLoading(false);
        }
      } else {
        fallbackDrawPoint(record);
        setTimeout(() => showLoading(false), 250);
      }
    }

    function fallbackDrawPoint(record) {
      drawOnMap(feedLayerGroup, record[1], record[2], record[3], record[4], false);
      mapDashboard.setView([record[1], record[2]], 16, { animate: false });
    }

    // ---------- Navigation core ----------
    var lastRouteUpdatePos = null;

    function startInternalNav(destLat, destLon, travelMode='driving') {
      if (!navigator.geolocation) { alert("GPS not supported"); return; }

      stopNavigation();
      showLoading(true, "STARTING NAV (" + travelMode.toUpperCase() + ")...");
      switchTab('dashboard');

      lastRouteUpdatePos = null;
      currentDestLatLng = L.latLng(destLat, destLon);

      navigator.geolocation.getCurrentPosition(function(pos) {
        var startLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
        lastRouteUpdatePos = startLatLng;

        mapDashboard.setView(startLatLng, 18);
        mapDashboard.setBearing(0);

        var routerServiceUrl = '';
        var routerProfile = '';
        if (travelMode === 'walking') {
          routerServiceUrl = 'https://routing.openstreetmap.de/routed-foot/route/v1';
          routerProfile = 'foot';
        } else {
          routerServiceUrl = 'https://routing.openstreetmap.de/routed-car/route/v1';
          routerProfile = 'driving';
        }

        try {
          routingControl = L.Routing.control({
            waypoints: [startLatLng, currentDestLatLng],
            routeWhileDragging: false,
            showAlternatives: false,
            fitSelectedRoutes: false,
            router: L.Routing.osrmv1({ serviceUrl: routerServiceUrl, profile: routerProfile }),
            lineOptions: {
              styles: [{
                color: travelMode === 'walking' ? '#06b6d4' : '#22c55e',
                opacity: 0.85,
                weight: 6,
                dashArray: travelMode === 'walking' ? '1, 10' : null
              }],
              missingRouteTolerance: 100
            },
            createMarker: function(i, wp) {
              if (i === 0) return null;
              return L.marker(wp.latLng);
            },
            addWaypoints: false
          })
          .on('routesfound', function(e) {
            var routes = e.routes;
            var summary = routes[0].summary;
            var instructions = routes[0].instructions;

            var timeDisplay = "";
            if (summary.totalTime > 3600) {
              var h = Math.floor(summary.totalTime / 3600);
              var m = Math.round((summary.totalTime % 3600) / 60);
              timeDisplay = h + " hr " + m + " min";
            } else {
              timeDisplay = Math.round(summary.totalTime / 60) + " min";
            }

            var html = `<div style="text-align:center; padding-bottom:10px; border-bottom:1px solid rgba(148,163,184,.18); margin-bottom:10px;">
              <div style="font-size:18px; font-weight:900; color:#22c55e;">
                <i class="fa ${travelMode==='walking'?'fa-male':'fa-car'}"></i> ${(summary.totalDistance/1000).toFixed(1)} km
              </div>
              <div style="font-size:13px; color:#cbd5e1;"><i class="fa fa-clock-o"></i> ${timeDisplay}</div>
            </div>`;

            instructions.forEach(ins => {
              var icon = "fa-dot-circle-o";
              if(ins.type === "Straight") icon = "fa-arrow-up";
              else if(ins.type === "Right") icon = "fa-arrow-right";
              else if(ins.type === "Left") icon = "fa-arrow-left";

              var text = (ins.text || "").replace('Head', 'Go').replace('Destination', 'Finish');
              html += `<div class="route-step-item">
                <div class="route-step-icon"><i class="fa ${icon}"></i></div>
                <div class="route-step-text">${text}</div>
                <div class="route-step-dist">${ins.distance < 1000 ? Math.round(ins.distance)+'m' : (ins.distance/1000).toFixed(1)+'km'}</div>
              </div>`;
            });

            document.getElementById('route-dynamic-content').innerHTML = html;
          })
          .addTo(mapDashboard);

          document.getElementById('nav-stop-ui').style.display = 'block';
          document.getElementById('btn-tool-route').style.display = 'flex';
          showLoading(false);

          navWatchId = navigator.geolocation.watchPosition(function(p) {
            var lat = p.coords.latitude;
            var lng = p.coords.longitude;
            var newStart = L.latLng(lat, lng);
            currentNavPos = { lat: lat, lng: lng };

            if(myLocationMarker) mapDashboard.removeLayer(myLocationMarker);
            myLocationMarker = L.circleMarker(newStart, { radius: 8, fillColor: "#3b82f6", color: "#ffffff", weight: 2, opacity: 1, fillOpacity: 0.9 }).addTo(mapDashboard);

            mapDashboard.panTo(newStart);

            if (p.coords.heading !== null && !isNaN(p.coords.heading) && p.coords.speed > 0.5) {
              mapDashboard.setBearing(p.coords.heading);
            }

            var dist = newStart.distanceTo(currentDestLatLng);
            var distEl = document.getElementById('dist-remain');
            var distTxt = dist < 1000 ? Math.round(dist) + " m" : (dist/1000).toFixed(1) + " km";

            if (navigator.onLine) {
              distEl.innerText = "(" + distTxt + ")";
              distEl.style.color = "#cbd5e1";
            } else {
              distEl.innerText = "(" + distTxt + ") [OFFLINE]";
              distEl.style.color = "#fecaca";
            }

            if (dist < 20) {
              stopNavigation();
              alert("üéâ You have arrived!");
              playBeep();
              return;
            }

            if (routingControl && navigator.onLine) {
              if (lastRouteUpdatePos && newStart.distanceTo(lastRouteUpdatePos) < 40) {
                // skip
              } else {
                var wps = routingControl.getWaypoints();
                routingControl.setWaypoints([newStart, wps[1].latLng]);
                lastRouteUpdatePos = newStart;
              }
            }
          }, function(err){ console.log(err); }, { enableHighAccuracy:true, maximumAge:0, timeout:5000 });

        } catch(e) {
          showLoading(false);
          alert("Error: " + e.message);
        }
      }, function(err){
        showLoading(false);
        alert("GPS Error: " + err.message);
      }, { enableHighAccuracy:true });
    }

    function stopNavigation() {
      if (navWatchId !== null) {
        navigator.geolocation.clearWatch(navWatchId);
        navWatchId = null;
      }
      currentNavPos = null;
      if (routingControl !== null) {
        mapDashboard.removeControl(routingControl);
        routingControl = null;
      }
      document.getElementById('nav-stop-ui').style.display = 'none';
      document.getElementById('btn-tool-route').style.display = 'none';
      document.getElementById('panel-route').style.display = 'none';
      document.getElementById('btn-tool-route').classList.remove('active');
      currentDestLatLng = null;
    }

    function undoLastPoint(){
      if(linePoints.length > 0) linePoints.pop();
      if(tempLine) mapReport.removeLayer(tempLine);
      if(linePoints.length > 1) tempLine = L.polyline(linePoints, {color:'#06b6d4', weight:4, dashArray:'10,10'}).addTo(mapReport);
      document.getElementById('coord-text').innerText = "ROUTE " + linePoints.length + " pts";
    }

    // ---------- Init ----------
    window.addEventListener('load', () => {
      updateSyncStatus();
      syncOfflineData();
      applyLanguage();
      checkAuth();

      var wasSOS = localStorage.getItem('is_sos_active') === 'true';
      if (!wasSOS) {
        if (localStorage.getItem('pending_sos_packet')) localStorage.removeItem('pending_sos_packet');
        localStorage.removeItem('session_sos_sent');
      }
      if (wasSOS && localStorage.getItem('pending_sos_packet')) {
        queueSosRetry(null);
      }
    });
  </script>
</body>
</html>
